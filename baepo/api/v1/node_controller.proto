syntax = "proto3";

package baepo.api.v1;

import "google/protobuf/timestamp.proto";
import "baepo/node/v1/machine.proto";

option go_package = "github.com/baepo-cloud/baepo-proto/go/baepo/api/v1";

service NodeControllerService {
  rpc Events(stream NodeControllerClientEvent) returns (stream NodeControllerServerEvent);
}

message NodeControllerServerEvent {
  oneof event {
    RegisterResponse register = 1;
    PingEvent ping = 2;
  }

  message RegisterResponse {
    string node_id = 1;
    string node_token = 2;
    bytes authority_cert = 3;
    bytes server_cert = 4;
    bytes server_key = 5;
  }

  message PingEvent {
  }
}

message NodeControllerClientEvent {
  oneof event {
    RegisterRequest register = 1;
    StatsEvent stats = 2;
    MachineStateChangeEvent machine_state_change = 3;
  }

  message RegisterRequest {
    string cluster_id = 1;
    string bootstrap_token = 2;
    optional string node_token = 3;
    string ip_address = 4;
    string api_endpoint = 5;
    string gateway_endpoint = 6;
  }

  message StatsEvent {
    uint64 total_memory_mb = 1;
    uint64 used_memory_mb = 2;
    uint64 reserved_memory_mb = 3;
    uint32 cpu_count = 4;
    map<string, baepo.node.v1.MachineState> machine_states = 5;
  }

  message MachineStateChangeEvent {
    string machine_id = 1;
    baepo.node.v1.MachineState state = 2;
    baepo.node.v1.MachineDesiredState desired_state = 3;
    google.protobuf.Timestamp timestamp = 4;
  }
}
